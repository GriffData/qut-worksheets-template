

***
*Solution*: 

(a) Assuming the multivariate normal distribution is correct, if we calculate the test-statistic $T_{i} = (\boldsymbol{X}_{i}-\boldsymbol{\mu})^{\top}\Sigma^{-1}(\boldsymbol{X}_{i}-\boldsymbol{\mu})$ it will have a Chi-square distribution. Therefore, any observations that are unlikely (with respect to the Chi-square distribution) warrant investigation. A Chi-square distribution with `df=3` has density

```{r sols-id0005-chi-sq-density,  fig.margin = TRUE, fig.cap = "Chi-square distribution with df=3. Area with 0.01 probability of occuring in red.", fig.width=3.5, fig.height=3.5, cache=TRUE}

pv <- 0.01
cs_df <- 3
T_upper <- 15

cutoff <-  qchisq(p = pv, df = cs_df, lower.tail = FALSE)

ggplot(mapping = aes(x = c(0,T_upper))) +
  
  stat_function(fun = dchisq, args = list(df = cs_df), 
                xlim = c(0,cutoff)) +
  
  geom_area(stat = "function", fun = dchisq, 
            args = list(df = cs_df), xlim = c(cutoff,T_upper), fill = "red") +
  
  geom_vline(xintercept = cutoff, colour = "red") +
  
  xlab("T") + ylab("p(T)") + theme_bw()


```

The decision rule is to investigate points that occur in the red region, which only has a 0.01 chance of occurring (hence unlikely). You can make your rule less conservative by increasing the red area (i.e. by increasing `pv`).

(b) 

```{r sols-id0005-test-function, eval = TRUE, echo = TRUE}

  is_outlier_mvn <- function(boat_obs, pv, boat_mu, boat_var){
    

    x <- boat_obs - boat_mu
    
    T_stat <- x %*% solve(boat_var, x)
    
    cutoff <- qchisq(p = pv, df = length(boat_mu), lower.tail = FALSE)
    
    return(
      T_stat > cutoff
    )
    
  }

```

(c) 

```{r sols-id0005-apply-function, eval = TRUE, echo = TRUE}


  test_set <- list(
    c(8.34, 20.85, 58.68),
    c(11.56, 18.76, 61.32),
    c(11.28, 15.00, 65.06),
    c(10.92, 17.90, 60.13),
    c(12.17, 18.54, 61.68),
    c(8.93, 22.91, 62.28),
    c(11.69, 20.23, 61.23),
    c(9.45, 19.74, 58.86),
    c(10.04, 20.53, 59.06),
    c(8.88, 20.29, 59.64)
  )

    boat_mu <- c(10, 20, 60)
    
    boat_var <- matrix(
      c( 1.0, -0.1,  0.4,
        -0.1,  2.0,  0.2,
         0.4,  0.2,  4.0 
        ),
      ncol = 3
    )

  sapply(test_set, 
         FUN = is_outlier_mvn, 
         pv = 0.05,  boat_mu = boat_mu, boat_var = boat_var) %>%
    which()
    

```

(d) 

```{r sols-id0005-part-d, eval = TRUE, echo = TRUE}


  detect_outliers_mvn <- function(data_list, pv){
    
    data_mat <- do.call("rbind",data_list)
    
    boat_mu <- colMeans(data_mat)
    
    boat_var <- var(data_mat)
    
    sapply(data_list, 
           FUN = is_outlier_mvn, 
           pv = pv,  boat_mu = boat_mu, boat_var = boat_var)
    
  }

  which( detect_outliers_mvn(data_list = test_set, pv = 0.05) )
    
  

```
With `pv = 0.05` using the sample mean and variance no longer reports observation 3 being a possible outlier/anomaly. This is because using the sample mean and variance approximates the true values and becomes less precise.

***